# Analysis pipeline and figures: Relevance of DNA Tridimensional Shape in RNA:DNA:DNA Triple Helix Formation
This repository contains the Snakemake and R code required to generate feature matrices and reproduce the downstream analyses and figures presented in the manuscript.
The analysis evaluates RNAâ€“DNA triplex formation by correlating predicted triplex stability scores (3plex) with DNA tridimensional shape features (Helix Twist, Minor Groove Width, Propeller Twist, and Roll) across selected lncRNAs.

---

## ğŸš€ How to Run
1.  **Clone the repository:**
    ```bash
    git clone https://github.com/molinerisLab/lncRNA_3plex_DNAshape.git
    ```
2.  **Navigate to the folder:**
    ```bash
    cd lncRNA_3plex_DNAshape
    ```
3.  **Run the analysis scripts:**
    You can run the script directly from the terminal, e.g. : 
    ```bash
    Rscript script.R
    ```
    *Alternatively, you can open .R and .Rmd in RStudio and source them.*
    
# ğŸ§¬ RNABSdb / 3D-DNA analysis pipeline
## ğŸ¯ Purpose
This Snakemake pipeline generates feature matrices and summary tables used to evaluate RNAâ€“DNA triplex formation across selected lncRNAs.
 It integrates:
   * triplex stability scores (from 3plex)
   * DNA shape features
   * multiple negative region definitions

Separate R Markdown scripts perform downstream analyses (ROC curves, model comparison, figures).

## âš™ï¸ Pipeline overview
The pipeline performs the following high-level steps:
1. Preparation of positive and negative genomic regions
   * Sorting and merging BED files
   * Separation of positive and negative regions

2. DNA shape feature extraction
   * Intersects genomic regions with DNA shape bigWig tracks
   * Computes mean shape values per region
   * Aggregates shape features across all lncRNAs and species

3. Triplex prediction (3plex)
   * Extracts lncRNA sequences from GENCODE
   * Extracts DNA sequences for target regions
   * Runs 3plex via Docker
   * Collects stability scores

4. Feature matrix construction
   * Joins DNA shape features with triplex stability scores
   * Produces final matrices used for statistical modeling

5. Summary table generation
   * Aggregates GLM coefficients and AUC values
   * Applies p-value adjustment
   * Produces tabular summaries for downstream inspection

Auxiliary analyses
Computes overlap of positive/negative regions with open chromatin (cCREs)

## ğŸ”§ Configuration
All lncRNA lists, feature definitions, and genome settings are defined in config.yaml, including:
   * Human and mouse lncRNAs
   * DNA shape features
   * Stability metrics
   * Negative region types
   * GENCODE species, version, and genome assembly

## ğŸ“¦ Dependencies
The pipeline relies on:
   * `Snakemake`
   * `bedtools`
   * `UCSC tools (bigWigToBedGraph, wigToBigWig)`
   * `bawk`
   * `matrix_reduce` 
   * `tab2matrix / tab2xlsx`
   * `Docker` (for running 3plex)

Reference genomes and GENCODE annotations must be available locally, as specified in the Snakefile and config.

## ğŸ“‚ Main outputs
Key outputs generated by the pipeline include:
   * DNA shape feature matrices
   * Triplex stability summaries
   * Combined shape + stability matrices `best_param_3plex/ALL_shape.3plex_stability.matrix.gz`
   * Aggregated coefficient and AUC summary tables
   * Chromatin fraction statistics for positive and negative regions

## ğŸ“‰ Downstream analysis
ROC curves, model comparisons, and heatmap plots are produced by separate R Markdown scripts that consume the matrices generated here.

## ğŸ cCRE-aware pipeline
In addition to the main pipeline, a separate Snakemake pipeline is provided to handle cCRE-aware negative datasets specifically.
This pipeline mirrors the structure and logic of the main RNABSdb / 3D-DNA pipeline, including:
   * preparation of positive and negative regions
   * extraction and aggregation of DNA shape features
   * integration with triplex stability scores
   * generation of feature matrices for downstream modeling

The key difference is that negative regions are defined using cabedshuffle.py cCREs-aware selection rather than being fully random. See [ConfoundingAwareBedShuffle](https://github.com/molinerisLab/ConfoundingAwareBedShuffle).
Outputs generated by the cCRE-aware pipeline are compatible with the same downstream R Markdown scripts used for ROC curve generation and model comparison.



# ROC curve generation - lncRNA_3plex_AUC.Rmd
##Purpose
This R Markdown script is part of the analysis pipeline and is used to generate ROC curves comparing logistic regression models based on:
   * triplex stability features alone
   * triplex stability features combined with DNA shape features

The script does not perform data preprocessing and assumes upstream pipeline steps have already generated all input matrices.

## ğŸ“¥ Inputs
The script reads precomputed feature matrices generated by the pipeline (e.g. ALL_shape.3plex_stability.matrix.gz) containing:
   * pos_neg labels (pos / neg)
   * stability features (e.g. Stability_best, Stability_norm)
   * DNA shape features (HelT, MGW, ProT, Roll)
   * lncRNA identifiers

Different negative sets are supported (random, all cCREs, biosample-specific cCREs), provided as separate input files.

## ğŸ“¦ Dependencies
Required R packages:
   * `dplyr`
   * `ggplot2`
   * `pROC`

## ğŸ“¤ Output
   * ROC curves comparing stability-only vs stability+shape models
   * AUC values displayed in plot legends

No intermediate data files are written.

## ğŸ“ Notes
Datasets are internally balanced by lncRNA via downsampling.
Random seeds are fixed to ensure reproducibility of sampling and plots.



# ROC curve comparison - ROC_square_plots.Rmd
## ğŸ¯ Purpose
This R Markdown script is part of the RNABSdb / 3D-DNA analysis pipeline and is used only to generate ROC curves comparing logistic regression models trained on:
   * random negative regions
   * cCRE-based negative regions

Comparisons are performed both:
   * on the full (lncRNA-balanced) dataset
   * on individual lncRNAs

## ğŸ“¥ Inputs
The script expects precomputed feature matrices containing:
   * pos_neg labels (pos / neg)
   * triplex stability features (e.g. Stability_best)
   * DNA shape features (HelT, MGW, ProT, Roll)
   * lncRNA identifiers

Separate input files are provided for random negatives and cCRE-based negatives.

## ğŸ“¦ Dependencies
Required R packages:
   * `dplyr`
   * `ggplot2`
   * `pROC`

## ğŸ“¤ Output
   * ROC curves comparing stability-only vs stability+shape models
   * Visual comparison of random vs cCRE-based negative sets
   * Per-lncRNA ROC plots

No intermediate or processed data files are generated.

## ğŸ“ Notes
Datasets are internally balanced by lncRNA via downsampling.
Random seeds are fixed to ensure reproducibility across runs.
This script is intended exclusively for visualization and model comparison within the pipeline.

---

# ğŸ“ˆ Correlation analysis - DNA Shape vs Stability

# ğŸ¯ Purpose
This R script reproduces the analysis for Supplementary Figures 4 and 5. It investigates the relationship between predicted triplex stability (3plex score) and DNA 3D shape features (Helix Twist, Minor Groove Width, Propeller Twist, and Roll) at two levels of resolution:
* **Aggregated Level:** Mean shape vs. mean stability per lncRNA.
* **Region Level:** Individual binding sites, analyzing local density and top-stability candidates.

## ğŸ“¥ Inputs
The script processes three distinct control datasets to test hypothesis stringency:
* `Random_Negatives` (Baseline comparison)
* `cCRE_Balanced` (Controls for open chromatin bias)
* `Biosample_Specific` (Strict cell-type specific control)

It requires the `ALL_shape.3plex_stability.matrix` generated by the upstream pipeline for each dataset.

## ğŸ“¦ Dependencies
The script automatically checks for and installs the following R packages:
* `tidyverse`
* `ggpubr`
* `data.table`
* `hexbin` (for density plotting)
* `ggpointdensity`

## ğŸ“Š Analysis Logic
1.  **Aggregation Analysis:** Calculates mean shape and score values for positive and negative sets, plotting linear regression for positives to assess global trends.
2.  **Global Density Visualization:** Visualizes the core distribution of stable triplexes using density coloring to handle high data volume (Supplementary Fig 5).
3.  **Faceted lncRNA Analysis:** Stratifies data by lncRNA, highlighting the **top 10%** highest-stability sites (yellow) against the background (gray) to identify specific shape preferences (Supplementary Fig 4).

## ğŸ“¤ Output
The script generates the following files for each dataset:
* **Scatterplot_[Dataset].pdf:** Aggregated mean correlation plots.
* **RegionPlot_OVERALL_DENSITY.pdf:** Density-colored scatterplot of all genomic binding sites.
* **RegionPlot_FACETED_Top10.pdf:** Per-lncRNA plots separating top 10% stable sites.
* **RegionPlot_FACETED_cor_table_Top10.csv:** Statistical table containing Pearson correlation coefficients and adjusted p-values.
